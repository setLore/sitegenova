<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>M&D — Shop</title>
	<link rel="stylesheet" href="css/shop.css">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
</head>
<body>
	<!-- header replaced with index.html header -->
	<header class="site-header">
		<a href="index.html" class="logo-link" aria-label="M&D home">
			<img src="logo.png" alt="M&D logo" class="logo">
		</a>
		<nav id="site-nav" class="nav-buttons" role="navigation">
			<a class="nav-link" href="index.html">Home</a>
			<a class="nav-link" href="shop.html">Shop</a>
			<div class="nav-item-with-dropdown" style="display:none;">
				<div class="nav-dropdown" role="menu" aria-label="Shop categories">
					<a class="nav-dropdown-item" href="shop.html?category=turbo" role="menuitem">Turbo</a>
					<a class="nav-dropdown-item" href="shop.html?category=intercooler" role="menuitem">Intercooler</a>
					<a class="nav-dropdown-item" href="shop.html?category=intake" role="menuitem">Cold Air Intake</a>
					<a class="nav-dropdown-item" href="shop.html?category=exhaust" role="menuitem">Exhaust System</a>
					<a class="nav-dropdown-item" href="shop.html?category=kess" role="menuitem">KESS</a>
					<a class="nav-dropdown-item" href="shop.html?category=coilovers" role="menuitem">Coilovers</a>
				</div>
			</div>
			<a class="nav-link" href="about.html">About</a>
		</nav>

		<div class="header-actions">
			<a class="cart-button" href="cart.html" aria-label="Open cart">
				<i class="bi bi-cart cart-icon" aria-hidden="true"></i>
				<span class="cart-count" aria-hidden="true">0</span>
			</a>
			<button class="menu-toggle" aria-controls="site-nav" aria-expanded="false" aria-label="Open menu">
				<span class="bar"></span>
				<span class="bar"></span>
				<span class="bar"></span>
			</button>
		</div>
	</header>

	<!-- ...existing product grid content ... -->
	<main class="page-main" role="main">
		<div class="page-header">
			<h1>Shop</h1>
			<div class="header-controls">
				<div class="search-bar">
					<input type="text" id="search-input" placeholder="Search products...">
					<button class="search-btn" aria-label="Search">
						<i class="bi bi-search" aria-hidden="true"></i>
					</button>
				</div>
				<div class="sort-dropdown">
					<button class="sort-btn" aria-label="Sort products" aria-expanded="false">
						<span>Sort</span>
						<i class="bi bi-funnel" aria-hidden="true"></i>
					</button>
					<ul class="sort-menu" role="menu">
						<li role="none"><button role="menuitem" data-sort="default">Default</button></li>
						<li role="none"><button role="menuitem" data-sort="price-low">Price: Low to High</button></li>
						<li role="none"><button role="menuitem" data-sort="price-high">Price: High to Low</button></li>
						<li role="none"><button role="menuitem" data-sort="name-asc">A - Z</button></li>
						<li role="none"><button role="menuitem" data-sort="name-desc">Z - A</button></li>
					</ul>
				</div>
			</div>
		</div>
		<div class="products" id="product-grid" tabindex="-1">
			<!-- Original 6 products with categories -->
			<div class="product" data-id="p1" data-name="Turbo" data-price="1099" data-category="turbo">
				<img src="turbo.png" alt="Turbo">
				<h3>Turbo</h3>
				<p>$1099</p>
				<div class="product-actions">
					<button class="preview-btn" type="button" aria-label="Preview Turbo">Preview</button>
					<button class="add-btn" type="button">Add to cart</button>
				</div>
			</div>
			<div class="product" data-id="p2" data-name="Intercooler Sport" data-price="499" data-category="intercooler">
				<img src="intercooler.png" alt="Intercooler Sport">
				<h3>Intercooler Sport</h3>
				<p>$499</p>
				<div class="product-actions">
					<button class="preview-btn" type="button" aria-label="Preview Intercooler Sport">Preview</button>
					<button class="add-btn" type="button">Add to cart</button>
				</div>
			</div>
			<div class="product" data-id="p3" data-name="Intake" data-price="299.00" data-category="intake">
				<img src="intake.png" alt="Intake">
				<h3>Cold Air Intake</h3>
				<p>$299</p>
				<div class="product-actions"> 
					<button class="preview-btn" type="button" aria-label="Preview Intake">Preview</button>
					<button class="add-btn" type="button">Add to cart</button>
				</div>
			</div>
			<div class="product" data-id="p4" data-name="Exhaust" data-price="999.00" data-category="exhaust">
				<img src="exhaust.png" alt="exhaust">
				<h3>Exhaust System</h3>
				<p>$999</p>
				<div class="product-actions">
					<button class="preview-btn" type="button" aria-label="Preview Exhaust System">Preview</button>
					<button class="add-btn" type="button">Add to cart</button>
				</div>
			</div>
			<div class="product" data-id="p5" data-name="Kess" data-price="2999.00" data-category="kess">
				<img src="kess.png" alt="KESS V2 ECU Programmer">
				<h3>KESS V2 ECU Programmer</h3>
				<p>$2999</p>
				<div class="product-actions">
					<button class="preview-btn" type="button" aria-label="Preview KESS V2 ECU Programmer">Preview</button>
					<button class="add-btn" type="button">Add to cart</button>
				</div>
			</div>
			<div class="product" data-id="p6" data-name="Coilovers" data-price="899.00" data-category="coilovers">
				<img src="coilover.png" alt="Coilovers">
				<h3>Coilovers</h3>
				<p>$899</p>
				<div class="product-actions">
					<button class="preview-btn" type="button" aria-label="Preview Coilovers">Preview</button>
					<button class="add-btn" type="button">Add to cart</button>
				</div>
			</div>

			<!-- New 6 products with categories -->
			<div class="product" data-id="p7" data-name="Turbo Kit Pro" data-price="1399" data-category="turbo">
				<img src="turbo2.png" alt="Turbo Kit Pro">
				<h3>Turbo Kit Pro</h3>
				<p>$1399</p>
				<div class="product-actions">
					<button class="preview-btn" type="button" aria-label="Preview Turbo Kit Pro">Preview</button>
					<button class="add-btn" type="button">Add to cart</button>
				</div>
			</div>
			<div class="product" data-id="p8" data-name="Intercooler" data-price="349" data-category="intercooler">
				<img src="intercooler2.png" alt="Intercooler">
				<h3>Intercooler</h3>
				<p>$349</p>
				<div class="product-actions">
					<button class="preview-btn" type="button" aria-label="Preview Intercooler Pipes">Preview</button>
					<button class="add-btn" type="button">Add to cart</button>
				</div>
			</div>
			<div class="product" data-id="p9" data-name="Performance Filter" data-price="179" data-category="intake">
				<img src="intake2.png" alt="Performance Intake">
				<h3>Performance Filter</h3>
				<p>$179</p>
				<div class="product-actions">
					<button class="preview-btn" type="button" aria-label="Preview Performance Filter">Preview</button>
					<button class="add-btn" type="button">Add to cart</button>
				</div>
			</div>
			<div class="product" data-id="p10" data-name="Exhaust Manifold" data-price="649" data-category="exhaust">
				<img src="exhaust2.png" alt="Exhaust Manifold">
				<h3>Exhaust Manifold</h3>
				<p>$649</p>
				<div class="product-actions">
					<button class="preview-btn" type="button" aria-label="Preview Exhaust Manifold">Preview</button>
					<button class="add-btn" type="button">Add to cart</button>
				</div>
			</div>
			<div class="product" data-id="p11" data-name="KESS Bench Edition" data-price="3299" data-category="kess">
				<img src="kessv3.png" alt="KESS Bench Edition">
				<h3>KESS Bench Edition</h3>
				<p>$3299</p>
				<div class="product-actions">
					<button class="preview-btn" type="button" aria-label="Preview KESS Bench Edition">Preview</button>
					<button class="add-btn" type="button">Add to cart</button>
				</div>
			</div>
			<div class="product" data-id="p12" data-name="Air Suspension Coils" data-price="1199" data-category="coilovers">
				<img src="coilovers2.png" alt="Air Suspension Coils">
				<h3>Air Suspension Coils</h3>
				<p>$1199</p>
				<div class="product-actions">
					<button class="preview-btn" type="button" aria-label="Preview Air Suspension Coils">Preview</button>
					<button class="add-btn" type="button">Add to cart</button>
				</div>
			</div>
		</div>
	</main>

	<!-- footer replaced with index.html footer -->
	<footer class="site-footer">
		<div class="site-footer-inner">
			<span class="footer-left">© M&amp;D 2025</span>
			<div class="social-buttons" role="group" aria-label="Social links">
				<a class="social-button social-instagram" href="https://www.instagram.com/825a14" target="_blank" rel="noopener noreferrer" aria-label="Open Instagram">
					<i class="bi bi-instagram" aria-hidden="true"></i>
				</a>
				<a class="social-button social-tiktok" href="https://www.tiktok.com/@00_dimov" target="_blank" rel="noopener noreferrer" aria-label="Open TikTok">
					<i class="bi bi-tiktok" aria-hidden="true"></i>
				</a>
				<a class="social-button social-facebook" href="https://www.facebook.com/" target="_blank" rel="noopener noreferrer" aria-label="Open Facebook">
					<i class="bi bi-facebook" aria-hidden="true"></i>
				</a>
			</div>
		</div>
	</footer>

	<!-- unified site script (shop.html) -->
	<script>
		(function(){
			const PAGE_SITE_TOKEN = 'site-v2';

			// If token changed, clear cart and notify other tabs
			(function ensureSiteToken(){
				const stored = localStorage.getItem('md_site_start_token');
				if (stored !== PAGE_SITE_TOKEN) {
					localStorage.removeItem('md_cart');
					localStorage.setItem('md_site_start_token', PAGE_SITE_TOKEN);
					localStorage.setItem('md_cart_sync', Date.now().toString());
				}
			})();

			/* Shared cart helpers */
			function getCart() {
				try { return JSON.parse(localStorage.getItem('md_cart') || '[]'); } catch (e) { return []; }
			}
			function saveCart(cart) {
				localStorage.setItem('md_cart', JSON.stringify(cart));
				localStorage.setItem('md_cart_sync', Date.now().toString());
			}
			function updateCartCount() {
				const cart = getCart();
				const totalQty = cart.reduce((s, i) => s + (i.qty || 1), 0);
				document.querySelectorAll('.cart-count').forEach(el => el.textContent = totalQty);
			}

			/* Menu toggle (shared) */
			(function bindMenuToggle(){
				const toggle = document.querySelector('.menu-toggle');
				const nav = document.getElementById('site-nav');
				if (!toggle || !nav) return;
				toggle.addEventListener('click', (e) => {
					e.stopPropagation();
					const isOpen = toggle.getAttribute('aria-expanded') === 'true';
					toggle.setAttribute('aria-expanded', String(!isOpen));
					toggle.setAttribute('aria-label', !isOpen ? 'Close menu' : 'Open menu');
					nav.classList.toggle('open', !isOpen);
				});
				nav.addEventListener('click', (e) => e.stopPropagation());
				
				// Dropdown toggle for Shop button on mobile
				const shopLink = document.querySelector('.nav-shop-link');
				const dropdown = document.querySelector('.nav-dropdown');
				if (shopLink && dropdown) {
					shopLink.addEventListener('click', (e) => {
						if (window.innerWidth <= 600) {
							e.preventDefault();
							dropdown.classList.toggle('open');
						}
					});
				}
				
				window.addEventListener('resize', () => {
					if (window.innerWidth > 600) {
						toggle.setAttribute('aria-expanded','false');
						nav.classList.remove('open');
						if (dropdown) dropdown.classList.remove('open');
					}
				});
				document.addEventListener('click', (e) => {
					if (window.innerWidth <= 600 && nav.classList.contains('open')) {
						if (!nav.contains(e.target) && !toggle.contains(e.target)) {
							toggle.setAttribute('aria-expanded','false');
							nav.classList.remove('open');
						}
					}
				});
			})();

			/* Sort and Filter functionality */
			(function bindSortAndFilter(){
				const sortBtn = document.querySelector('.sort-btn');
				const sortMenu = document.querySelector('.sort-menu');
				const searchInput = document.getElementById('search-input');
				const productGrid = document.getElementById('product-grid');
				const products = Array.from(productGrid.querySelectorAll('.product'));
				let currentSort = 'default';
				let currentCategory = '';

				// Get category from URL on load
				const urlParams = new URLSearchParams(window.location.search);
				currentCategory = urlParams.get('category') || '';

				// Toggle sort menu
				if (sortBtn) {
					sortBtn.addEventListener('click', (e) => {
						e.stopPropagation();
						const isOpen = sortBtn.getAttribute('aria-expanded') === 'true';
						sortBtn.setAttribute('aria-expanded', String(!isOpen));
						sortMenu.classList.toggle('open', !isOpen);
					});
				}

				// Sort menu items click
				if (sortMenu) {
					sortMenu.querySelectorAll('[data-sort]').forEach(btn => {
						btn.addEventListener('click', (e) => {
							e.stopPropagation();
							currentSort = btn.dataset.sort;
							sortBtn.setAttribute('aria-expanded', 'false');
							sortMenu.classList.remove('open');
							applyFilters();
						});
					});
				}

				// Search input
				if (searchInput) {
					searchInput.addEventListener('input', () => {
						applyFilters();
					});
				}

				function applyFilters() {
					const searchTerm = searchInput.value.toLowerCase();
					let filtered = products.filter(product => {
						const name = product.dataset.name?.toLowerCase() || '';
						const title = product.querySelector('h3')?.textContent.toLowerCase() || '';
						const category = product.dataset.category || '';
						const matchesSearch = name.includes(searchTerm) || title.includes(searchTerm);
						const matchesCategory = !currentCategory || category === currentCategory;
						return matchesSearch && matchesCategory;
					});

					// Apply sorting
					filtered.sort((a, b) => {
						const aName = (a.dataset.name || '').toLowerCase();
						const bName = (b.dataset.name || '').toLowerCase();
						const aPrice = parseFloat(a.dataset.price || 0);
						const bPrice = parseFloat(b.dataset.price || 0);

						switch(currentSort) {
							case 'price-low':
								return aPrice - bPrice;
							case 'price-high':
								return bPrice - aPrice;
							case 'name-asc':
								return aName.localeCompare(bName);
							case 'name-desc':
								return bName.localeCompare(aName);
							case 'default':
							default:
								return products.indexOf(a) - products.indexOf(b);
						}
					});

					// Reorder and toggle visibility
					products.forEach(product => {
						product.style.display = 'none';
					});
					
					filtered.forEach(product => {
						product.style.display = '';
						productGrid.appendChild(product);
					});
				}

				// Close menu on outside click
				document.addEventListener('click', (e) => {
					if (sortBtn && !sortBtn.contains(e.target) && !sortMenu.contains(e.target)) {
						sortBtn.setAttribute('aria-expanded', 'false');
						sortMenu.classList.remove('open');
					}
				});

				// Initial filter on page load
				applyFilters();
			})();

			/* Shop: Add to cart (if product grid exists) */
			if (productGrid) {
				function addToCart(item) {
					const cart = getCart();
					const idx = cart.findIndex(i => i.id === item.id);
					if (idx > -1) cart[idx].qty = (cart[idx].qty || 1) + 1;
					else cart.push({ ...item, qty: 1 });
					saveCart(cart);
					updateCartCount();
				}
				document.addEventListener('click', (e) => {
					if (e.target.matches('.add-btn')) {
						const card = e.target.closest('.product');
						if (!card) return;
						const id = card.dataset.id;
						const name = card.dataset.name;
						const price = parseFloat(card.dataset.price || '0');
						const imgEl = card.querySelector('img');
						const img = imgEl ? imgEl.getAttribute('src') : '';
						addToCart({ id, name, price, image: img });
						// UI feedback
						const btn = e.target;
						const prev = btn.textContent;
						btn.textContent = 'Added';
						setTimeout(() => btn.textContent = prev, 700);
					}
				});
			}

			/* React to storage changes */
			window.addEventListener('storage', (ev) => {
				if (ev.key === 'md_cart' || ev.key === 'md_cart_sync') {
					updateCartCount();
				}
			});

			/* Init badge on load */
			if (document.readyState === 'loading') {
				document.addEventListener('DOMContentLoaded', updateCartCount);
			} else {
				updateCartCount();
			}
		})();
	</script>

		<!-- product preview modal -->
		<div id="product-preview" class="preview-modal" aria-hidden="true">
			<div class="pm-backdrop" data-action="close" tabindex="-1"></div>
			<div class="pm-window" role="dialog" aria-modal="true" aria-labelledby="pm-title">
				<button class="pm-close preview-btn" aria-label="Close preview">×</button>
				<img class="pm-image" src="" alt="" />
				<div class="pm-body">
					<h2 id="pm-title"></h2>
					<p class="pm-price"></p>
					<p class="pm-desc"></p>
					<div class="pm-actions">
						<button class="modal-add add-btn" type="button">Add to cart</button>
						<button class="pm-close-secondary preview-btn" type="button">Close</button>
					</div>
				</div>
			</div>
		</div>

		<script>
		// Modal preview script (standalone so it works independent from main IIFE)
		(function(){
			const descriptions = [
				"High-performance part engineered for durability and peak power.",
				"Precision-built component with excellent fitment and finish.",
				"Popular choice among enthusiasts — reliable and great value.",
				"Hand-tested item with a 12-month limited warranty.",
				"Race-inspired design that improves throttle response and flow."
			];

			const preview = document.getElementById('product-preview');
			const pmTitle = preview.querySelector('#pm-title');
			const pmPrice = preview.querySelector('.pm-price');
			const pmDesc = preview.querySelector('.pm-desc');
			const pmImage = preview.querySelector('.pm-image');
			const pmCloseBtns = preview.querySelectorAll('.pm-close, .pm-close-secondary');
			const pmBackdrop = preview.querySelector('.pm-backdrop');
			const modalAdd = preview.querySelector('.modal-add');
			let lastActive = null;

			function openModal(data, triggerEl){
				lastActive = triggerEl || document.activeElement;
				pmTitle.textContent = data.name || '';
				pmPrice.textContent = data.price ? ('$' + data.price) : '';
				pmImage.src = data.image || '';
				pmImage.alt = data.name || '';
				pmDesc.textContent = descriptions[Math.floor(Math.random()*descriptions.length)];
				preview.setAttribute('aria-hidden', 'false');
				preview.classList.add('open');
				// focus close button for easy keyboard close
				const btn = preview.querySelector('.pm-close');
				if (btn) btn.focus();
			}

			function closeModal(){
				preview.setAttribute('aria-hidden', 'true');
				preview.classList.remove('open');
				if (lastActive) {
					// If the trigger came from inside a product, blur it to remove :focus-within
					const insideProduct = lastActive.closest && lastActive.closest('.product');
					if (insideProduct) {
						try { lastActive.blur(); } catch(e) { /* ignore */ }
						const grid = document.getElementById('product-grid');
						if (grid && typeof grid.focus === 'function') grid.focus();
					} else if (typeof lastActive.focus === 'function') {
						lastActive.focus();
					}
				}
			}

			document.addEventListener('click', (e) => {
				if (e.target.matches('.preview-btn')){
					const card = e.target.closest('.product');
					if (!card) return;
					const data = {
						id: card.dataset.id,
						name: card.dataset.name || card.querySelector('h3')?.textContent,
						price: card.dataset.price,
						image: card.querySelector('img')?.getAttribute('src') || ''
					};
					openModal(data, e.target);
				}
				if (e.target === pmBackdrop || e.target.matches('[data-action="close"]')) closeModal();
				if (e.target.matches('.pm-close-secondary')) closeModal();
				if (e.target.matches('.modal-add')){
					// simple add-to-cart: mirror main add logic to localStorage
					const card = preview.querySelector('#pm-title');
					const id = preview.querySelector('#pm-title')?.dataset?.id || null;
					const name = pmTitle.textContent;
					const priceText = pmPrice.textContent.replace(/[^0-9.]/g,'') || '0';
					const price = parseFloat(priceText);
					const img = pmImage.src || '';
					// add to localStorage cart
					try{
						const cart = JSON.parse(localStorage.getItem('md_cart') || '[]');
						const idx = cart.findIndex(i => i.id === id);
						if (idx > -1) cart[idx].qty = (cart[idx].qty || 1) + 1;
						else cart.push({ id: id || (name+Math.random()), name, price, image: img, qty: 1 });
						localStorage.setItem('md_cart', JSON.stringify(cart));
						localStorage.setItem('md_cart_sync', Date.now().toString());
						// update visible counters
						document.querySelectorAll('.cart-count').forEach(el => {
							const total = cart.reduce((s,i)=> s + (i.qty||1), 0);
							el.textContent = total;
						});
					}catch(err){/* ignore */}
					// small feedback then close
					const b = preview.querySelector('.modal-add');
					const prev = b.textContent;
					b.textContent = 'Added';
					setTimeout(()=>{ b.textContent = prev; closeModal(); }, 700);
				}
			});

			document.addEventListener('keydown', (e) => {
				if (e.key === 'Escape' && preview.classList.contains('open')) closeModal();
			});

			pmCloseBtns.forEach(btn => btn.addEventListener('click', closeModal));

		})();
		</script>
</body>
</html>
